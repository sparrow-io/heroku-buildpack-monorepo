#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir> <env-dir>
#
# Sparrow Monorepo Buildpack
#
# STRATEGY: Keep the monorepo structure INTACT so that relative gem paths work.
# Instead of moving apps/api to root (which breaks ../../packages/ruby/tnef),
# we keep everything in place and configure Bundler to find the Gemfile.
#
# Config vars:
#   PROJECT_PATH - path to the app subdirectory (e.g., apps/api)

shopt -s dotglob

BUILD_DIR=${1:-}
CACHE_DIR=${2:-}
ENV_DIR=${3:-}

indent() {
    sed -u 's/^/       /'
}

# Read PROJECT_PATH
if [ -f "$ENV_DIR/PROJECT_PATH" ]; then
    PROJECT_PATH=$(cat "$ENV_DIR/PROJECT_PATH")
else
    PROJECT_PATH="apps/api"
fi

echo "-----> Sparrow Monorepo Buildpack"
echo "       PROJECT_PATH: $PROJECT_PATH" | indent

# Verify the project path exists
if [ ! -d "$BUILD_DIR/$PROJECT_PATH" ]; then
    echo "ERROR: PROJECT_PATH '$PROJECT_PATH' does not exist in build directory" | indent
    exit 1
fi

# Verify Gemfile exists in the project
if [ ! -f "$BUILD_DIR/$PROJECT_PATH/Gemfile" ]; then
    echo "ERROR: No Gemfile found in $PROJECT_PATH" | indent
    exit 1
fi

# Symlink Gemfile and Gemfile.lock to root for heroku/ruby buildpack detection
echo "       Symlinking Gemfile and Gemfile.lock to root..." | indent
ln -sf "$PROJECT_PATH/Gemfile" "$BUILD_DIR/Gemfile"
ln -sf "$PROJECT_PATH/Gemfile.lock" "$BUILD_DIR/Gemfile.lock"
echo "       Created symlinks: Gemfile -> $PROJECT_PATH/Gemfile" | indent

# Export BUNDLE_GEMFILE for subsequent buildpacks via .profile.d
export_dir="$BUILD_DIR/.profile.d"
mkdir -p "$export_dir"
cat > "$export_dir/monorepo.sh" << EOF
# Set BUNDLE_GEMFILE for runtime
export BUNDLE_GEMFILE=\$HOME/$PROJECT_PATH/Gemfile
export MONOREPO_PROJECT_PATH=$PROJECT_PATH
EOF
echo "       Created .profile.d/monorepo.sh for runtime BUNDLE_GEMFILE" | indent

# Create build-time BUNDLE_GEMFILE export for subsequent buildpacks
mkdir -p "$BUILD_DIR/.heroku/env"
cat > "$BUILD_DIR/.heroku/env/BUNDLE_GEMFILE.sh" << EOF
export BUNDLE_GEMFILE="$BUILD_DIR/$PROJECT_PATH/Gemfile"
EOF
echo "       Created build-time BUNDLE_GEMFILE export" | indent

# Create Procfile at root if it doesn't exist
if [ ! -f "$BUILD_DIR/Procfile" ]; then
    echo "       Creating Procfile at root to run from $PROJECT_PATH..." | indent
    
    if [ -f "$BUILD_DIR/$PROJECT_PATH/Procfile" ]; then
        while IFS=':' read -r proc_name proc_cmd || [ -n "$proc_name" ]; do
            [[ -z "$proc_name" || "$proc_name" =~ ^[[:space:]]*# ]] && continue
            proc_name=$(echo "$proc_name" | xargs)
            proc_cmd=$(echo "$proc_cmd" | xargs)
            echo "$proc_name: cd $PROJECT_PATH && $proc_cmd" >> "$BUILD_DIR/Procfile"
        done < "$BUILD_DIR/$PROJECT_PATH/Procfile"
        echo "       Generated root Procfile from $PROJECT_PATH/Procfile" | indent
    else
        cat > "$BUILD_DIR/Procfile" << EOF
web: cd $PROJECT_PATH && bundle exec puma -C config/puma.rb
EOF
        echo "       Created default web Procfile" | indent
    fi
fi

# Create bin/ shims at root so heroku run commands work
echo "       Creating bin/ shims at root for heroku run commands..." | indent
mkdir -p "$BUILD_DIR/bin"

cat > "$BUILD_DIR/bin/rails" << EOF
#!/usr/bin/env bash
cd "\$(dirname "\$0")/../$PROJECT_PATH" && exec bin/rails "\$@"
EOF
chmod +x "$BUILD_DIR/bin/rails"

cat > "$BUILD_DIR/bin/rake" << EOF
#!/usr/bin/env bash
cd "\$(dirname "\$0")/../$PROJECT_PATH" && exec bin/rake "\$@"
EOF
chmod +x "$BUILD_DIR/bin/rake"

echo "       Created shims: bin/rails, bin/rake" | indent

echo "       Monorepo structure preserved. Gem paths will resolve correctly." | indent
echo "       Build directory contents:" | indent
ls -la "$BUILD_DIR" | head -10 | indent

echo "-----> Monorepo buildpack complete"
exit 0
