#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir> <env-dir>
#
# Sparrow Monorepo Buildpack - Flatten Approach
#
# STRATEGY: Extract only the Rails app and Ruby packages from the monorepo,
# flatten everything to root level. This gives:
# - Minimal slug size (only Ruby-related files)
# - Clean structure (app at root, packages/ruby/* alongside)
# - No path rewriting complexity
# - Standard Heroku Ruby buildpack behavior
#
# Config vars:
#   PROJECT_PATH - path to the app subdirectory (e.g., apps/api)

set -e
shopt -s dotglob

BUILD_DIR=${1:-}
CACHE_DIR=${2:-}
ENV_DIR=${3:-}

indent() {
    sed -u 's/^/       /'
}

# Read PROJECT_PATH
if [ -f "$ENV_DIR/PROJECT_PATH" ]; then
    PROJECT_PATH=$(cat "$ENV_DIR/PROJECT_PATH")
else
    PROJECT_PATH="apps/api"
fi

echo "-----> Sparrow Monorepo Buildpack (Flatten Mode)"
echo "       PROJECT_PATH: $PROJECT_PATH" | indent

# Verify the project path exists
if [ ! -d "$BUILD_DIR/$PROJECT_PATH" ]; then
    echo "ERROR: PROJECT_PATH '$PROJECT_PATH' does not exist in build directory" | indent
    exit 1
fi

# Verify Gemfile exists in the project
if [ ! -f "$BUILD_DIR/$PROJECT_PATH/Gemfile" ]; then
    echo "ERROR: No Gemfile found in $PROJECT_PATH" | indent
    exit 1
fi

# Step 1: Stage what we need to a temp location
echo "       Staging files to extract..." | indent
STAGING_DIR=$(mktemp -d)

# Copy the Rails app contents (will become root)
echo "       - Copying $PROJECT_PATH/* (Rails app)" | indent
cp -r "$BUILD_DIR/$PROJECT_PATH"/* "$STAGING_DIR/"

# Copy packages/ruby if it exists (for local gems)
if [ -d "$BUILD_DIR/packages/ruby" ]; then
    echo "       - Copying packages/ruby/* (local gems)" | indent
    mkdir -p "$STAGING_DIR/packages/ruby"
    cp -r "$BUILD_DIR/packages/ruby"/* "$STAGING_DIR/packages/ruby/"
    
    # Clean up spec directories from local gems to reduce slug size
    echo "       - Removing spec directories from local gems" | indent
    rm -rf "$STAGING_DIR/packages/ruby"/*/spec 2>/dev/null || true
    rm -rf "$STAGING_DIR/packages/ruby"/*/test 2>/dev/null || true
fi

# Step 2: Clear the build directory
echo "       Clearing build directory..." | indent
rm -rf "$BUILD_DIR"/*
rm -rf "$BUILD_DIR"/.[!.]* 2>/dev/null || true

# Step 3: Copy staged files back to root
echo "       Flattening to root..." | indent
cp -r "$STAGING_DIR"/* "$BUILD_DIR/"
cp -r "$STAGING_DIR"/.[!.]* "$BUILD_DIR/" 2>/dev/null || true

# Step 4: Rewrite Gemfile paths (../../packages/ruby/X -> packages/ruby/X)
echo "       Rewriting gem paths in Gemfile..." | indent
if [ -f "$BUILD_DIR/Gemfile" ]; then
    sed -i "s|path: ['\"]\.\./../\([^'\"]*\)['\"]|path: '\1'|g" "$BUILD_DIR/Gemfile"
fi

# Step 5: Rewrite Gemfile.lock paths
echo "       Rewriting gem paths in Gemfile.lock..." | indent
if [ -f "$BUILD_DIR/Gemfile.lock" ]; then
    sed -i "s|remote: ../../|remote: |g" "$BUILD_DIR/Gemfile.lock"
fi

# Show what paths look like after rewriting
echo "       Rewritten gem paths:" | indent
grep -E "path:.*packages" "$BUILD_DIR/Gemfile" 2>/dev/null | head -5 | indent || echo "       (no path gems in Gemfile)" | indent

# Clean up staging
rm -rf "$STAGING_DIR"

# Show final structure
echo "       Final build directory:" | indent
ls -la "$BUILD_DIR" | head -15 | indent

echo "-----> Monorepo buildpack complete (flattened to root)"
exit 0
